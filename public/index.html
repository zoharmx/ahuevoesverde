<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Huevo Es Verde - Almuerzos y Jugos | Nogales, Sonora</title>
    <meta name="description" content="A Huevo Es Verde - Los mejores almuerzos con huevos y jugos naturales en Nogales, Sonora. Servicio a domicilio especializado en entregas a la aduana.">

    <meta property="og:title" content="A Huevo Es Verde - Almuerzos y Jugos">
    <meta property="og:description" content="Almuerzos deliciosos con huevos y jugos naturales. Entrega r√°pida a la aduana de Nogales.">
    <meta property="og:image" content="/images/6f694ae6-8898-4889-a769-82766dbf3725.png">
    <meta property="og:url" content="https://ahuevoesverde.web.app">
    <meta property="og:type" content="website">

    <link rel="icon" href="/images/favicon.png" type="image/png">
    <link rel="apple-touch-icon" href="/images/favicon.png">

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#66D9EF">

    <!-- Firebase -->
    <script defer src="/__/firebase/12.5.0/firebase-app-compat.js"></script>
    <script defer src="/__/firebase/12.5.0/firebase-auth-compat.js"></script>
    <script defer src="/__/firebase/12.5.0/firebase-database-compat.js"></script>
    <script defer src="/__/firebase/12.5.0/firebase-functions-compat.js"></script>
    <script defer src="/__/firebase/12.5.0/firebase-analytics-compat.js"></script>
    <script defer src="/__/firebase/init.js"></script>

    <!-- Stripe -->
    <script src="https://js.stripe.com/v3/"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'egg-yellow': '#FDB813',
                        'fresh-green': '#7CB342',
                        'sky-blue': '#66D9EF',
                        'sunny-orange': '#FF9800',
                        'desert-red': '#E53935',
                        'warm-beige': '#F5E6D3'
                    },
                    fontFamily: {
                        'display': ['Fredoka', 'Poppins', 'sans-serif'],
                        'body': ['Inter', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --egg-gradient: linear-gradient(135deg, #FDB813 0%, #FF9800 100%);
            --green-gradient: linear-gradient(135deg, #7CB342 0%, #558B2F 100%);
            --sky-gradient: linear-gradient(135deg, #66D9EF 0%, #42A5F5 100%);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #E3F2FD 0%, #FFF9C4 50%, #E3F2FD 100%);
            color: #333;
            overflow-x: hidden;
        }

        .font-display {
            font-family: 'Fredoka', 'Poppins', sans-serif;
            font-weight: 600;
        }

        /* Hero Section */
        .hero-section {
            background: linear-gradient(135deg, #66D9EF 0%, #7CB342 100%);
            position: relative;
            overflow: hidden;
        }

        .hero-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image:
                radial-gradient(circle at 20% 80%, rgba(251, 140, 0, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(124, 179, 66, 0.3) 0%, transparent 50%);
            animation: pulse 10s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* Card Effects */
        .menu-card {
            background: white;
            border-radius: 1.5rem;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 3px solid transparent;
            cursor: pointer;
        }

        .menu-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(253, 184, 19, 0.3);
            border-color: #FDB813;
        }

        /* Floating Nav */
        .floating-nav {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.95);
            border-bottom: 2px solid rgba(253, 184, 19, 0.3);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* Buttons */
        .btn-primary {
            background: var(--egg-gradient);
            color: white;
            font-weight: 600;
            padding: 0.875rem 2rem;
            border-radius: 2rem;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(253, 184, 19, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(253, 184, 19, 0.6);
        }

        .btn-secondary {
            background: var(--green-gradient);
            color: white;
            font-weight: 600;
            padding: 0.875rem 2rem;
            border-radius: 2rem;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(124, 179, 66, 0.4);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(124, 179, 66, 0.6);
        }

        /* Cart Badge */
        .cart-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #E53935;
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            min-width: 1.5rem;
            text-align: center;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.show {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background: white;
            border-radius: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid rgba(253, 184, 19, 0.3);
            border-radius: 50%;
            border-top-color: #FDB813;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Quantity Controls */
        .quantity-control {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: #F5F5F5;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
        }

        .quantity-btn {
            background: var(--egg-gradient);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s ease;
        }

        .quantity-btn:hover {
            transform: scale(1.1);
        }

        /* Delivery Address Input */
        .delivery-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #E0E0E0;
            border-radius: 1rem;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .delivery-input:focus {
            outline: none;
            border-color: #FDB813;
        }

        /* Order Status */
        .status-indicator {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .status-pending { background: #FFF3E0; color: #E65100; }
        .status-preparing { background: #E3F2FD; color: #1565C0; }
        .status-delivering { background: #F3E5F5; color: #6A1B9A; }
        .status-delivered { background: #E8F5E9; color: #2E7D32; }

        /* Smooth Scrolling */
        html {
            scroll-behavior: smooth;
        }

        /* Price Tag */
        .price-tag {
            background: var(--egg-gradient);
            color: white;
            padding: 0.5rem 1.25rem;
            border-radius: 2rem;
            font-weight: 700;
            font-size: 1.25rem;
            display: inline-block;
        }

        /* Category Pills */
        .category-pill {
            padding: 0.625rem 1.5rem;
            border-radius: 2rem;
            border: 2px solid #E0E0E0;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .category-pill.active {
            background: var(--egg-gradient);
            color: white;
            border-color: #FDB813;
        }

        .category-pill:hover {
            border-color: #FDB813;
            transform: translateY(-2px);
        }

        /* Fade In Animation */
        .fade-in {
            opacity: 0;
            animation: fadeIn 0.8s ease forwards;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        /* WhatsApp Button */
        .whatsapp-fab {
            position: fixed;
            bottom: 2rem;
            left: 2rem;
            background: #25D366;
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.5);
            cursor: pointer;
            transition: transform 0.3s ease;
            z-index: 999;
        }

        .whatsapp-fab:hover {
            transform: scale(1.1);
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #F5F5F5;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--egg-gradient);
            border-radius: 5px;
        }

        /* Responsive Images */
        img {
            max-width: 100%;
            height: auto;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1001;
            border-left: 4px solid #7CB342;
        }

        .toast.show {
            transform: translateX(0);
        }

        /* iOS Install Prompt */
        .ios-prompt {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #66D9EF 0%, #42A5F5 100%);
            padding: 1rem;
            text-align: center;
            z-index: 999;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.2);
            animation: slideUpPrompt 0.4s ease;
        }

        @keyframes slideUpPrompt {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .ios-prompt-content {
            max-width: 600px;
            margin: 0 auto;
        }

        .ios-prompt-text {
            color: white;
            font-size: 0.95rem;
            margin-bottom: 0.75rem;
            line-height: 1.5;
        }

        .ios-prompt-text strong {
            font-weight: 700;
            text-decoration: underline;
        }

        .ios-prompt-icon {
            display: inline-block;
            font-size: 1.25rem;
            margin: 0 0.25rem;
            vertical-align: middle;
        }

        .ios-close-btn {
            background: rgba(255, 255, 255, 0.3);
            color: white;
            border: 2px solid white;
            padding: 0.5rem 1.5rem;
            border-radius: 2rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .ios-close-btn:hover {
            background: white;
            color: #42A5F5;
        }

        /* Slide down animation */
        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        /* Favorite button */
        .favorite-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255, 255, 255, 0.9);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .favorite-btn:hover {
            transform: scale(1.1);
            background: white;
        }

        .favorite-btn.active {
            background: #E53935;
            color: white;
        }

        .favorite-btn.active:hover {
            background: #C62828;
        }

        /* Order tracking timeline */
        .tracking-timeline {
            position: relative;
            padding-left: 2rem;
        }

        .tracking-step {
            position: relative;
            padding-bottom: 2rem;
        }

        .tracking-step::before {
            content: '';
            position: absolute;
            left: -1.5rem;
            top: 0.5rem;
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            background: #E0E0E0;
        }

        .tracking-step.active::before {
            background: #7CB342;
            box-shadow: 0 0 0 4px rgba(124, 179, 66, 0.2);
        }

        .tracking-step:not(:last-child)::after {
            content: '';
            position: absolute;
            left: -1.05rem;
            top: 1.5rem;
            width: 2px;
            height: calc(100% - 1rem);
            background: #E0E0E0;
        }

        .tracking-step.active:not(:last-child)::after {
            background: #7CB342;
        }

        /* Delivery time estimator */
        .time-badge {
            display: inline-block;
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-weight: 600;
            font-size: 0.875rem;
            animation: pulse 2s ease-in-out infinite;
        }

        /* Quick reorder button */
        .quick-reorder {
            position: fixed;
            bottom: 6rem;
            right: 2rem;
            background: linear-gradient(135deg, #FDB813 0%, #FF9800 100%);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 12px rgba(253, 184, 19, 0.5);
            cursor: pointer;
            transition: transform 0.3s ease;
            z-index: 998;
            border: none;
        }

        .quick-reorder:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <!-- Floating Navigation -->
    <nav class="floating-nav fixed top-0 left-0 right-0 z-50">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <img src="/images/6f694ae6-8898-4889-a769-82766dbf3725.png" alt="A Huevo Es Verde" class="w-12 h-12">
                    <div>
                        <h1 class="font-display text-xl text-gray-800">A Huevo Es Verde</h1>
                        <p class="text-xs text-gray-600">Almuerzos y Jugos</p>
                    </div>
                </div>

                <div class="flex items-center gap-4">
                    <button id="currency-toggle-btn" onclick="toggleCurrency()" class="hidden md:block text-gray-700 hover:text-egg-yellow transition font-semibold">
                        <i class="fas fa-peso-sign mr-2"></i>Mostrar en MXN
                    </button>
                    <button id="my-orders-btn" onclick="showMyOrders()" class="hidden md:block text-gray-700 hover:text-egg-yellow transition">
                        <i class="fas fa-receipt mr-2"></i>Mis Pedidos
                    </button>
                    <button id="user-menu-btn" onclick="toggleUserMenu()" class="hidden text-gray-700 hover:text-egg-yellow transition">
                        <i class="fas fa-user-circle text-2xl"></i>
                    </button>
                    <button id="login-btn" onclick="showLoginModal()" class="hidden md:block text-gray-700 hover:text-egg-yellow transition">
                        <i class="fas fa-sign-in-alt mr-2"></i>Iniciar Sesi√≥n
                    </button>
                    <button onclick="showCart()" class="relative btn-primary">
                        <i class="fas fa-shopping-cart"></i>
                        <span id="cart-count" class="cart-badge hidden">0</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero-section relative pt-32 pb-20 px-4">
        <div class="container mx-auto text-center relative z-10">
            <div class="fade-in">
                <img src="/images/6f694ae6-8898-4889-a769-82766dbf3725.png" alt="A Huevo Es Verde" class="w-48 h-48 mx-auto mb-6 drop-shadow-2xl">
                <h1 class="font-display text-5xl md:text-7xl text-white mb-4 drop-shadow-lg">
                    A Huevo Es Verde
                </h1>
                <p class="text-2xl md:text-3xl text-white mb-3 font-medium">
                    Almuerzos y Jugos Naturales
                </p>
                <p class="text-lg md:text-xl text-white mb-8 opacity-90">
                    Servicio a domicilio en Nogales, Sonora
                </p>
                <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
                    <a href="#menu" class="btn-primary text-lg">
                        <i class="fas fa-utensils mr-2"></i>Ver Men√∫
                    </a>
                    <a href="tel:+526311081965" class="btn-secondary text-lg">
                        <i class="fas fa-phone mr-2"></i>Llamar Ahora
                    </a>
                </div>

                <div class="mt-12 bg-white/90 backdrop-blur-sm rounded-2xl p-6 max-w-2xl mx-auto">
                    <h3 class="font-display text-2xl text-gray-800 mb-4">
                        <i class="fas fa-truck text-sunny-orange mr-2"></i>
                        Entrega Especial a la Aduana
                    </h3>
                    <p class="text-gray-700 text-lg">
                        Servicio r√°pido para personas en proceso de importaci√≥n.
                        Desde Acacia Frondosa hasta tu ubicaci√≥n en aproximadamente 20 minutos.
                    </p>
                </div>
            </div>
        </div>
    </section>

    <!-- Category Filter -->
    <section id="menu" class="container mx-auto px-4 py-8">
        <div class="flex gap-3 justify-center flex-wrap mb-8">
            <button class="category-pill active" onclick="filterCategory('all')">
                <i class="fas fa-th mr-2"></i>Todo
            </button>
            <button class="category-pill" onclick="filterCategory('Platillos')">
                <i class="fas fa-egg mr-2"></i>Platillos
            </button>
            <button class="category-pill" onclick="filterCategory('Bebidas')">
                <i class="fas fa-glass-water mr-2"></i>Bebidas
            </button>
        </div>
    </section>

    <!-- Menu Grid -->
    <section class="container mx-auto px-4 pb-20">
        <div id="menu-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- Menu items will be loaded here dynamically -->
        </div>

        <div id="loading" class="text-center py-20">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-gray-600 font-medium">Cargando el men√∫...</p>
        </div>
    </section>

    <!-- Cart Modal -->
    <div id="cart-modal" class="modal">
        <div class="modal-content">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h2 class="font-display text-3xl text-gray-800">
                        <i class="fas fa-shopping-cart text-egg-yellow mr-2"></i>
                        Tu Pedido
                    </h2>
                    <button onclick="hideCart()" class="text-gray-500 hover:text-gray-700 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <div id="cart-items" class="p-6">
                <!-- Cart items will be rendered here -->
            </div>

            <div id="cart-empty" class="p-12 text-center hidden">
                <i class="fas fa-shopping-basket text-6xl text-gray-300 mb-4"></i>
                <p class="text-gray-600 text-lg">Tu carrito est√° vac√≠o</p>
                <button onclick="hideCart()" class="btn-primary mt-4">
                    Explorar Men√∫
                </button>
            </div>

            <div id="cart-footer" class="p-6 border-t border-gray-200 bg-gray-50 rounded-b-2rem hidden">
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">
                        <i class="fas fa-map-marker-alt text-desert-red mr-2"></i>
                        Direcci√≥n de entrega
                    </label>
                    <input
                        type="text"
                        id="delivery-address"
                        class="delivery-input"
                        placeholder="Ej: Aduana Nogales, m√≥dulo 3"
                        required
                    >
                    <p class="text-sm text-gray-500 mt-2">
                        <i class="fas fa-info-circle mr-1"></i>
                        Especifica si es en la aduana u otra ubicaci√≥n en Nogales
                    </p>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">
                        <i class="fas fa-phone text-fresh-green mr-2"></i>
                        Tel√©fono de contacto
                    </label>
                    <input
                        type="tel"
                        id="delivery-phone"
                        class="delivery-input"
                        placeholder="Ej: 631 123 4567"
                        required
                    >
                </div>

                <div class="flex items-center justify-between mb-4 text-xl">
                    <span class="font-bold text-gray-700">Total:</span>
                    <span id="cart-total" class="price-tag">$0.00</span>
                </div>

                <div class="space-y-3">
                    <button onclick="proceedToCheckout()" class="btn-primary w-full text-lg">
                        <i class="fas fa-credit-card mr-2"></i>
                        Pagar en L√≠nea
                    </button>
                    <button onclick="orderWhatsApp()" class="btn-secondary w-full text-lg">
                        <i class="fab fa-whatsapp mr-2"></i>
                        Ordenar por WhatsApp
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div id="order-modal" class="modal">
        <div class="modal-content">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h2 class="font-display text-3xl text-gray-800">
                        <i class="fas fa-receipt text-egg-yellow mr-2"></i>
                        Detalle del Platillo
                    </h2>
                    <button onclick="hideOrderModal()" class="text-gray-500 hover:text-gray-700 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <div id="order-modal-content" class="p-6">
                <!-- Order details will be rendered here -->
            </div>
        </div>
    </div>

    <!-- My Orders Modal -->
    <div id="my-orders-modal" class="modal">
        <div class="modal-content">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h2 class="font-display text-3xl text-gray-800">
                        <i class="fas fa-clipboard-list text-egg-yellow mr-2"></i>
                        Mis Pedidos
                    </h2>
                    <button onclick="hideMyOrders()" class="text-gray-500 hover:text-gray-700 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <div id="my-orders-content" class="p-6">
                <!-- Orders will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="modal">
        <div class="modal-content max-w-md">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h2 class="font-display text-3xl text-gray-800">
                        <i class="fas fa-user-circle text-egg-yellow mr-2"></i>
                        Iniciar Sesi√≥n
                    </h2>
                    <button onclick="hideLoginModal()" class="text-gray-500 hover:text-gray-700 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <div class="p-6">
                <p class="text-gray-600 mb-6 text-center">
                    Inicia sesi√≥n para guardar tus pedidos y acceder a un historial completo
                </p>

                <!-- Google Sign In -->
                <button onclick="signInWithGoogle()" class="w-full bg-white border-2 border-gray-300 hover:border-gray-400 text-gray-700 font-semibold py-3 px-4 rounded-xl mb-3 transition flex items-center justify-center gap-3">
                    <svg width="20" height="20" viewBox="0 0 20 20">
                        <path fill="#4285F4" d="M19.6 10.23c0-.82-.1-1.42-.25-2.05H10v3.72h5.5c-.15.96-.74 2.31-2.04 3.22v2.45h3.16c1.89-1.73 2.98-4.3 2.98-7.34z"/>
                        <path fill="#34A853" d="M13.46 15.13c-.83.59-1.96 1-3.46 1-2.64 0-4.88-1.74-5.68-4.15H1.07v2.52C2.72 17.75 6.09 20 10 20c2.7 0 4.96-.89 6.62-2.42l-3.16-2.45z"/>
                        <path fill="#FBBC05" d="M3.99 10c0-.69.12-1.35.32-1.97V5.51H1.07A9.973 9.973 0 000 10c0 1.61.39 3.14 1.07 4.49l3.24-2.52c-.2-.62-.32-1.28-.32-1.97z"/>
                        <path fill="#EA4335" d="M10 3.88c1.88 0 3.13.81 3.85 1.48l2.84-2.76C14.96.99 12.7 0 10 0 6.09 0 2.72 2.25 1.07 5.51l3.24 2.52C5.12 5.62 7.36 3.88 10 3.88z"/>
                    </svg>
                    Continuar con Google
                </button>

                <div class="flex items-center gap-3 my-4">
                    <div class="flex-1 border-t border-gray-300"></div>
                    <span class="text-gray-500 text-sm">o</span>
                    <div class="flex-1 border-t border-gray-300"></div>
                </div>

                <!-- Email/Password Sign In -->
                <form id="email-login-form" onsubmit="signInWithEmail(event)" class="space-y-4">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">
                            <i class="fas fa-envelope mr-2"></i>Email
                        </label>
                        <input
                            type="email"
                            id="login-email"
                            class="delivery-input"
                            placeholder="tu@email.com"
                            required
                        >
                    </div>

                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">
                            <i class="fas fa-lock mr-2"></i>Contrase√±a
                        </label>
                        <input
                            type="password"
                            id="login-password"
                            class="delivery-input"
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                            required
                        >
                    </div>

                    <button type="submit" class="btn-primary w-full text-lg">
                        <i class="fas fa-sign-in-alt mr-2"></i>
                        Iniciar Sesi√≥n
                    </button>
                </form>

                <div class="mt-4 text-center">
                    <p class="text-gray-600">
                        ¬øNo tienes cuenta?
                        <button onclick="showRegisterForm()" class="text-fresh-green font-semibold hover:underline">
                            Reg√≠strate aqu√≠
                        </button>
                    </p>
                </div>

                <div id="register-form" class="hidden mt-6 pt-6 border-t border-gray-200">
                    <h3 class="font-display text-xl text-gray-800 mb-4">Crear Cuenta</h3>
                    <form onsubmit="registerWithEmail(event)" class="space-y-4">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">
                                <i class="fas fa-user mr-2"></i>Nombre
                            </label>
                            <input
                                type="text"
                                id="register-name"
                                class="delivery-input"
                                placeholder="Tu nombre"
                                required
                            >
                        </div>

                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">
                                <i class="fas fa-envelope mr-2"></i>Email
                            </label>
                            <input
                                type="email"
                                id="register-email"
                                class="delivery-input"
                                placeholder="tu@email.com"
                                required
                            >
                        </div>

                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">
                                <i class="fas fa-lock mr-2"></i>Contrase√±a
                            </label>
                            <input
                                type="password"
                                id="register-password"
                                class="delivery-input"
                                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                minlength="6"
                                required
                            >
                        </div>

                        <button type="submit" class="btn-secondary w-full text-lg">
                            <i class="fas fa-user-plus mr-2"></i>
                            Crear Cuenta
                        </button>
                    </form>

                    <div class="mt-4 text-center">
                        <button onclick="hideRegisterForm()" class="text-gray-600 hover:underline">
                            Ya tengo cuenta
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- WhatsApp FAB -->
    <a href="https://wa.me/526311081965" target="_blank" class="whatsapp-fab" title="Contactar por WhatsApp">
        <i class="fab fa-whatsapp"></i>
    </a>

    <!-- Quick Reorder Button -->
    <button id="quick-reorder-btn" class="quick-reorder" style="display: none;" onclick="quickReorder()" title="Repetir √∫ltimo pedido">
        <i class="fas fa-redo-alt"></i>
    </button>

    <!-- iOS Installation Prompt -->
    <div id="ios-prompt" style="display: none;">
        <!-- iOS prompt will be inserted here by JavaScript -->
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <div class="flex items-center gap-3">
            <i class="fas fa-check-circle text-fresh-green text-xl"></i>
            <span id="toast-message">Producto agregado al carrito</span>
        </div>
    </div>

    <!-- Offline Indicator -->
    <div id="offline-indicator" style="display: none; position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: #FF5722; color: white; padding: 0.75rem 1.5rem; border-radius: 2rem; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 1000; animation: slideDown 0.3s ease;">
        <i class="fas fa-wifi" style="text-decoration: line-through; margin-right: 0.5rem;"></i>
        <span>Sin conexi√≥n - Modo offline</span>
    </div>

    <!-- Update Available Banner -->
    <div id="update-banner" style="display: none; position: fixed; bottom: 0; left: 0; right: 0; background: #4CAF50; color: white; padding: 1rem; text-align: center; z-index: 1000; box-shadow: 0 -4px 12px rgba(0,0,0,0.2);">
        <span style="margin-right: 1rem;">üì¶ Nueva versi√≥n disponible</span>
        <button onclick="updateApp()" style="background: white; color: #4CAF50; border: none; padding: 0.5rem 1.5rem; border-radius: 2rem; font-weight: 600; cursor: pointer;">
            Actualizar ahora
        </button>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-12 mt-20">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center md:text-left">
                <div>
                    <h3 class="font-display text-2xl mb-4 text-egg-yellow">A Huevo Es Verde</h3>
                    <p class="text-gray-300">Almuerzos y jugos naturales en Nogales, Sonora</p>
                </div>

                <div>
                    <h4 class="font-bold mb-3 text-egg-yellow">Contacto</h4>
                    <p class="text-gray-300 mb-2">
                        <i class="fas fa-phone mr-2"></i>631 108 1965
                    </p>
                    <p class="text-gray-300 mb-2">
                        <i class="fas fa-map-marker-alt mr-2"></i>Acacia Frondosa, Nogales, Sonora
                    </p>
                    <p class="text-gray-300">
                        <i class="fas fa-clock mr-2"></i>Lun - Dom: 7:00 AM - 3:00 PM
                    </p>
                </div>

                <div>
                    <h4 class="font-bold mb-3 text-egg-yellow">S√≠guenos</h4>
                    <div class="flex gap-4 justify-center md:justify-start">
                        <a href="#" class="text-2xl hover:text-egg-yellow transition">
                            <i class="fab fa-facebook"></i>
                        </a>
                        <a href="#" class="text-2xl hover:text-egg-yellow transition">
                            <i class="fab fa-instagram"></i>
                        </a>
                        <a href="#" class="text-2xl hover:text-egg-yellow transition">
                            <i class="fab fa-whatsapp"></i>
                        </a>
                    </div>
                </div>
            </div>

            <div class="border-t border-gray-700 mt-8 pt-6 text-center text-gray-400">
                <p>&copy; 2025 A Huevo Es Verde. Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>

    <script>
        // Global State
        let menuData = [];
        let cart = [];
        let currentCategory = 'all';
        let firebaseDb = null;
        let firebaseAuth = null;
        let currentUser = null;
        let stripe = null;
        let serviceWorkerReg = null;
        let favorites = [];
        let lastOrder = null;
        let activeOrderTracking = null;
        let exchangeRate = 20; // Default exchange rate USD to MXN
        let showPricesInMXN = false; // Toggle between USD and MXN

        // ===== CURRENCY CONVERTER =====

        // Fetch exchange rate from API
        async function fetchExchangeRate() {
            try {
                // Using exchangerate-api.com (free tier)
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                const data = await response.json();
                if (data && data.rates && data.rates.MXN) {
                    exchangeRate = data.rates.MXN;
                    console.log('[Currency] Exchange rate updated:', exchangeRate, 'MXN per USD');
                    localStorage.setItem('ahuevo-exchange-rate', exchangeRate);
                    localStorage.setItem('ahuevo-exchange-rate-time', Date.now());
                }
            } catch (error) {
                console.error('[Currency] Failed to fetch exchange rate:', error);
                // Try to load from localStorage
                const savedRate = localStorage.getItem('ahuevo-exchange-rate');
                if (savedRate) {
                    exchangeRate = parseFloat(savedRate);
                    console.log('[Currency] Using cached exchange rate:', exchangeRate);
                }
            }
        }

        // Convert price based on current currency selection
        function convertPrice(priceUSD) {
            if (showPricesInMXN) {
                return priceUSD * exchangeRate;
            }
            return priceUSD;
        }

        // Format price with currency symbol
        function formatPrice(priceUSD) {
            const price = convertPrice(priceUSD);
            const currency = showPricesInMXN ? 'MXN' : 'USD';
            const symbol = showPricesInMXN ? '$' : '$';
            return `${symbol}${price.toFixed(2)} ${currency}`;
        }

        // Toggle currency display
        function toggleCurrency() {
            showPricesInMXN = !showPricesInMXN;
            localStorage.setItem('ahuevo-show-mxn', showPricesInMXN);

            // Update currency toggle button
            const toggleBtn = document.getElementById('currency-toggle-btn');
            if (toggleBtn) {
                toggleBtn.innerHTML = showPricesInMXN
                    ? '<i class="fas fa-dollar-sign mr-2"></i>Mostrar en USD'
                    : '<i class="fas fa-peso-sign mr-2"></i>Mostrar en MXN';
            }

            // Re-render menu with new prices
            renderMenu();

            // Update cart if open
            const cartModal = document.getElementById('cart-modal');
            if (cartModal.classList.contains('show')) {
                renderCart();
            }

            showToast(`Precios mostrados en ${showPricesInMXN ? 'MXN' : 'USD'}`);
        }

        // Load currency preference
        function loadCurrencyPreference() {
            const savedPreference = localStorage.getItem('ahuevo-show-mxn');
            if (savedPreference !== null) {
                showPricesInMXN = savedPreference === 'true';
            }

            // Load cached exchange rate if available and less than 24 hours old
            const savedRate = localStorage.getItem('ahuevo-exchange-rate');
            const savedTime = localStorage.getItem('ahuevo-exchange-rate-time');
            if (savedRate && savedTime) {
                const age = Date.now() - parseInt(savedTime);
                if (age < 24 * 60 * 60 * 1000) { // Less than 24 hours
                    exchangeRate = parseFloat(savedRate);
                    console.log('[Currency] Using cached exchange rate:', exchangeRate);
                }
            }
        }

        // iOS Detection Functions
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        }

        function isInStandaloneMode() {
            return ('standalone' in window.navigator) && (window.navigator.standalone);
        }

        function showIOSPrompt() {
            const iosPrompt = document.getElementById('ios-prompt');
            iosPrompt.innerHTML = `
                <div class="ios-prompt">
                    <div class="ios-prompt-content">
                        <p class="ios-prompt-text">
                            üì± <strong>Instala la app</strong> para una mejor experiencia:
                            <br>
                            Toca <span class="ios-prompt-icon">
                                <svg width="20" height="20" fill="white" viewBox="0 0 50 50" style="display: inline-block; vertical-align: middle;">
                                    <path d="M25 10 L25 30 M25 30 L15 20 M25 30 L35 20" stroke="white" stroke-width="4" fill="none"/>
                                    <rect x="10" y="35" width="30" height="4" fill="white"/>
                                </svg>
                            </span> <strong>Compartir</strong>
                            y luego <strong>"Agregar a pantalla de inicio"</strong>
                        </p>
                        <button onclick="closeIOSPrompt()" class="ios-close-btn">
                            Entendido
                        </button>
                    </div>
                </div>
            `;
            iosPrompt.style.display = 'block';

            // Save that we've shown the prompt
            localStorage.setItem('ahuevo-ios-prompt-shown', 'true');
        }

        function closeIOSPrompt() {
            const iosPrompt = document.getElementById('ios-prompt');
            iosPrompt.style.display = 'none';
        }

        // Check and show iOS prompt if needed - SMART TIMING
        function checkIOSPrompt() {
            if (isIOS() && !isInStandaloneMode()) {
                const promptShown = localStorage.getItem('ahuevo-ios-prompt-shown');
                const cartInteractions = parseInt(localStorage.getItem('ahuevo-cart-interactions') || '0');

                // Show after user has interacted with cart (added items)
                if (!promptShown && cartInteractions >= 2) {
                    setTimeout(() => {
                        showIOSPrompt();
                    }, 1000);
                }
            }
        }

        // Track cart interactions for smart timing
        function trackCartInteraction() {
            const current = parseInt(localStorage.getItem('ahuevo-cart-interactions') || '0');
            localStorage.setItem('ahuevo-cart-interactions', (current + 1).toString());
            checkIOSPrompt(); // Check if we should show prompt now
        }

        // ===== SERVICE WORKER & PWA FUNCTIONS =====

        // Register Service Worker
        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    serviceWorkerReg = await navigator.serviceWorker.register('/service-worker.js');
                    console.log('[PWA] Service Worker registered:', serviceWorkerReg);

                    // Check for updates
                    serviceWorkerReg.addEventListener('updatefound', () => {
                        const newWorker = serviceWorkerReg.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // New version available
                                showUpdateBanner();
                            }
                        });
                    });

                    // Request notification permission after SW registration
                    await requestNotificationPermission();
                } catch (error) {
                    console.error('[PWA] Service Worker registration failed:', error);
                }
            }
        }

        // Show update banner
        function showUpdateBanner() {
            document.getElementById('update-banner').style.display = 'block';
        }

        // Update app
        function updateApp() {
            if (serviceWorkerReg && serviceWorkerReg.waiting) {
                serviceWorkerReg.waiting.postMessage({ type: 'SKIP_WAITING' });
                window.location.reload();
            }
        }

        // Request notification permission
        async function requestNotificationPermission() {
            if ('Notification' in window && serviceWorkerReg) {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    console.log('[Notifications] Permission granted');
                    subscribeToPushNotifications();
                }
            }
        }

        // Subscribe to push notifications
        async function subscribeToPushNotifications() {
            try {
                // In production, you would use your VAPID public key here
                const subscription = await serviceWorkerReg.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: null // Add your VAPID key
                });
                console.log('[Notifications] Subscribed:', subscription);
                // Send subscription to your server
            } catch (error) {
                console.error('[Notifications] Subscription failed:', error);
            }
        }

        // Send local notification
        function sendLocalNotification(title, options = {}) {
            if ('Notification' in window && Notification.permission === 'granted') {
                if (serviceWorkerReg) {
                    serviceWorkerReg.showNotification(title, {
                        icon: '/images/6f694ae6-8898-4889-a769-82766dbf3725.png',
                        badge: '/images/6f694ae6-8898-4889-a769-82766dbf3725.png',
                        vibrate: [200, 100, 200],
                        ...options
                    });
                }
            }
        }

        // ===== OFFLINE DETECTION =====

        function updateOnlineStatus() {
            const indicator = document.getElementById('offline-indicator');
            if (!navigator.onLine) {
                indicator.style.display = 'block';
                showToast('Modo offline activado', 'warning');
            } else {
                indicator.style.display = 'none';
                // Sync any pending data
                syncOfflineData();
            }
        }

        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);

        // Sync offline data when connection is restored
        async function syncOfflineData() {
            const offlineOrders = JSON.parse(localStorage.getItem('ahuevo-offline-orders') || '[]');
            if (offlineOrders.length > 0 && firebaseDb) {
                showToast('Sincronizando pedidos offline...', 'info');
                for (const order of offlineOrders) {
                    try {
                        await firebaseDb.ref('orders').push(order);
                    } catch (error) {
                        console.error('[Offline] Failed to sync order:', error);
                    }
                }
                localStorage.removeItem('ahuevo-offline-orders');
                showToast('Pedidos sincronizados correctamente', 'success');
            }
        }

        // ===== FAVORITES SYSTEM =====

        function loadFavorites() {
            favorites = JSON.parse(localStorage.getItem('ahuevo-favorites') || '[]');
            updateFavoriteButtons();
        }

        function toggleFavorite(slug) {
            const index = favorites.indexOf(slug);
            if (index > -1) {
                favorites.splice(index, 1);
                showToast('Eliminado de favoritos', 'info');
            } else {
                favorites.push(slug);
                showToast('Agregado a favoritos ‚ù§Ô∏è', 'success');
            }
            localStorage.setItem('ahuevo-favorites', JSON.stringify(favorites));
            updateFavoriteButtons();
        }

        function updateFavoriteButtons() {
            document.querySelectorAll('.favorite-btn').forEach(btn => {
                const slug = btn.dataset.slug;
                if (favorites.includes(slug)) {
                    btn.classList.add('active');
                    btn.innerHTML = '<i class="fas fa-heart"></i>';
                } else {
                    btn.classList.remove('active');
                    btn.innerHTML = '<i class="far fa-heart"></i>';
                }
            });
        }

        // ===== QUICK REORDER =====

        function loadLastOrder() {
            lastOrder = JSON.parse(localStorage.getItem('ahuevo-last-order') || 'null');
            if (lastOrder) {
                document.getElementById('quick-reorder-btn').style.display = 'flex';
            }
        }

        function saveLastOrder(items) {
            lastOrder = items;
            localStorage.setItem('ahuevo-last-order', JSON.stringify(items));
            document.getElementById('quick-reorder-btn').style.display = 'flex';
        }

        function quickReorder() {
            if (!lastOrder || lastOrder.length === 0) {
                showToast('No hay pedidos anteriores', 'warning');
                return;
            }

            // Add all items from last order to cart
            lastOrder.forEach(item => {
                const existingItem = cart.find(i => i.slug === item.slug);
                if (existingItem) {
                    existingItem.quantity += item.quantity;
                } else {
                    cart.push({ ...item });
                }
            });

            saveCartToStorage();
            updateCartUI();
            showToast('Pedido anterior agregado al carrito üîÑ', 'success');
            showCart();

            // Send notification
            sendLocalNotification('Pedido repetido', {
                body: `${lastOrder.length} platillos agregados al carrito`,
                tag: 'quick-reorder'
            });
        }

        // ===== DELIVERY TIME ESTIMATOR =====

        function estimateDeliveryTime(address) {
            const lowerAddress = address.toLowerCase();

            // Check if it's aduana
            if (lowerAddress.includes('aduana') || lowerAddress.includes('frontera')) {
                return { min: 15, max: 20, location: 'Aduana' };
            }

            // Check if it's within Nogales
            if (lowerAddress.includes('nogales') || lowerAddress.includes('centro')) {
                return { min: 20, max: 30, location: 'Nogales' };
            }

            // Default
            return { min: 25, max: 35, location: 'Zona' };
        }

        function showDeliveryEstimate(address) {
            const estimate = estimateDeliveryTime(address);
            const estimateHTML = `
                <div class="bg-blue-50 rounded-lg p-3 mb-4">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-clock text-blue-600"></i>
                        <div>
                            <p class="font-semibold text-blue-900">Tiempo estimado de entrega</p>
                            <p class="text-blue-700">
                                <span class="time-badge">${estimate.min}-${estimate.max} minutos</span>
                                a ${estimate.location}
                            </p>
                        </div>
                    </div>
                </div>
            `;
            return estimateHTML;
        }

        // ===== ORDER TRACKING =====

        function startOrderTracking(orderId) {
            if (!firebaseDb) return;

            // Listen for order status changes
            const orderRef = firebaseDb.ref(`orders/${orderId}`);
            orderRef.on('value', (snapshot) => {
                const order = snapshot.val();
                if (order) {
                    updateOrderTrackingUI(order);

                    // Send notification on status change
                    if (activeOrderTracking && activeOrderTracking.status !== order.status) {
                        const statusMessages = {
                            'preparing': 'üç≥ Tu pedido est√° siendo preparado',
                            'delivering': 'üöó Tu pedido est√° en camino',
                            'delivered': '‚úÖ Tu pedido ha sido entregado'
                        };

                        if (statusMessages[order.status]) {
                            sendLocalNotification('Actualizaci√≥n de pedido', {
                                body: statusMessages[order.status],
                                tag: 'order-status',
                                requireInteraction: true
                            });
                        }
                    }

                    activeOrderTracking = order;
                }
            });
        }

        function updateOrderTrackingUI(order) {
            // This would update a tracking modal or component
            console.log('[Tracking] Order update:', order.status);
        }

        // Initialize App
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize Firebase
            try {
                const app = firebase.app();
                firebaseDb = firebase.database();
                firebaseAuth = firebase.auth();
                firebase.analytics();
                console.log('Firebase initialized successfully');

                // Listen for auth state changes
                firebaseAuth.onAuthStateChanged((user) => {
                    currentUser = user;
                    updateAuthUI();
                    if (user) {
                        console.log('User logged in:', user.email);
                    }
                });
            } catch (e) {
                console.error('Firebase initialization error:', e);
            }

            // Initialize Stripe
            stripe = Stripe('pk_test_51RbCCvKonyBsOy3O2TriW569SL7rTc4Qj7MV1NZC1nNQQysFnRWGZ6pRWwPn4kBlWU3Aei9b776eYm23gsuQMfxr00jCcUGUFK');

            // Register Service Worker for PWA features
            await registerServiceWorker();

            // Load currency preference and fetch exchange rate
            loadCurrencyPreference();
            await fetchExchangeRate();

            // Update currency toggle button text
            const toggleBtn = document.getElementById('currency-toggle-btn');
            if (toggleBtn) {
                toggleBtn.innerHTML = showPricesInMXN
                    ? '<i class="fas fa-dollar-sign mr-2"></i>Mostrar en USD'
                    : '<i class="fas fa-peso-sign mr-2"></i>Mostrar en MXN';
            }

            // Load menu data
            await loadMenu();

            // Load cart from localStorage
            loadCartFromStorage();

            // Update cart UI
            updateCartUI();

            // Load favorites
            loadFavorites();

            // Load last order for quick reorder
            loadLastOrder();

            // Check online status
            updateOnlineStatus();

            // Check if we should show iOS installation prompt
            checkIOSPrompt();

            // Check if returning from Stripe payment
            checkStripeReturn();
        });

        // Check if user is returning from Stripe payment
        function checkStripeReturn() {
            const urlParams = new URLSearchParams(window.location.search);
            const success = urlParams.get('success');
            const canceled = urlParams.get('canceled');

            // Check for pending order
            const pendingOrder = localStorage.getItem('ahuevo-pending-order');

            if (success === 'true' && pendingOrder) {
                try {
                    const orderInfo = JSON.parse(pendingOrder);

                    // Mark order as paid in Firebase
                    if (firebaseDb && orderInfo.orderId) {
                        firebaseDb.ref(`orders/${orderInfo.orderId}`).update({
                            status: 'preparing',
                            paidAt: firebase.database.ServerValue.TIMESTAMP,
                            paymentCompleted: true
                        });
                    }

                    // Clear pending order
                    localStorage.removeItem('ahuevo-pending-order');

                    // Clear cart
                    cart = [];
                    saveCartToStorage();
                    updateCartUI();

                    // Show success message
                    setTimeout(() => {
                        alert(`¬°Pago exitoso! üéâ\n\nTu pedido #${orderInfo.orderId.substring(0, 8)} ha sido confirmado.\n\nLo prepararemos y entregaremos en aproximadamente 20-30 minutos a:\n${orderInfo.address}\n\n¬°Gracias por tu compra!`);
                    }, 500);

                    // Clean URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                } catch (error) {
                    console.error('Error processing Stripe return:', error);
                }
            } else if (canceled === 'true') {
                showToast('Pago cancelado. Tu pedido est√° pendiente.', 'info');

                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // Load Menu
        async function loadMenu() {
            try {
                console.log('[Menu] Cargando men√∫...');
                const response = await fetch('/menu.json', {
                    cache: 'no-cache', // Force fresh data
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                menuData = await response.json();
                console.log('[Menu] Men√∫ cargado:', menuData.length, 'items');

                if (!menuData || menuData.length === 0) {
                    throw new Error('Menu data is empty');
                }

                renderMenu();
                document.getElementById('loading').classList.add('hidden');
            } catch (error) {
                console.error('[Menu] Error loading menu:', error);
                document.getElementById('loading').innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-exclamation-triangle text-6xl text-red-300 mb-4"></i>
                        <p class="text-red-600 font-medium text-lg mb-4">Error al cargar el men√∫</p>
                        <button onclick="location.reload()" class="btn-primary">
                            <i class="fas fa-redo mr-2"></i>Recargar P√°gina
                        </button>
                    </div>
                `;
            }
        }

        // Render Menu
        function renderMenu() {
            console.log('[Menu] Rendering menu, category:', currentCategory);
            const menuGrid = document.getElementById('menu-grid');

            if (!menuGrid) {
                console.error('[Menu] Menu grid element not found!');
                return;
            }

            const filteredData = currentCategory === 'all'
                ? menuData
                : menuData.filter(item => item.category === currentCategory);

            console.log('[Menu] Filtered items:', filteredData.length);

            if (filteredData.length === 0) {
                menuGrid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-search text-6xl text-gray-300 mb-4"></i>
                        <p class="text-gray-600 text-lg">No hay platillos en esta categor√≠a</p>
                    </div>
                `;
                return;
            }

            menuGrid.innerHTML = filteredData.map(item => `
                <div class="menu-card p-6 fade-in" data-category="${item.category}" style="position: relative;">
                    <button class="favorite-btn" data-slug="${item.slug}" onclick="event.stopPropagation(); toggleFavorite('${item.slug}')">
                        <i class="far fa-heart"></i>
                    </button>
                    <div class="mb-4 bg-gradient-to-br from-egg-yellow to-sunny-orange rounded-xl overflow-hidden h-48">
                        ${item.image ? `
                            <img src="${item.image}" alt="${item.name}" class="w-full h-full object-cover">
                        ` : `
                            <div class="w-full h-full flex items-center justify-center">
                                <i class="fas ${item.category === 'Bebidas' ? 'fa-glass-water' : 'fa-egg'} text-white text-7xl"></i>
                            </div>
                        `}
                    </div>

                    <h3 class="font-display text-2xl text-gray-800 mb-2">${item.name}</h3>
                    <p class="text-gray-600 text-sm mb-4 line-clamp-3">${item.desc || ''}</p>

                    ${item.ingredients ? `
                        <div class="mb-4">
                            <p class="text-xs font-semibold text-gray-500 mb-2">Incluye:</p>
                            <div class="flex flex-wrap gap-1">
                                ${item.ingredients.slice(0, 3).map(ing => `
                                    <span class="text-xs bg-gray-100 px-2 py-1 rounded-full">${ing}</span>
                                `).join('')}
                                ${item.ingredients.length > 3 ? `<span class="text-xs text-gray-500">+${item.ingredients.length - 3} m√°s</span>` : ''}
                            </div>
                        </div>
                    ` : ''}

                    <div class="flex items-center justify-between">
                        <span class="text-2xl font-bold text-gray-800">${formatPrice(item.price)}</span>
                        <button
                            onclick="addToCart('${item.slug}')"
                            class="btn-primary text-sm"
                            title="Agregar al carrito"
                        >
                            <i class="fas fa-plus mr-1"></i>Agregar
                        </button>
                    </div>

                    <button
                        onclick="showItemDetails('${item.slug}')"
                        class="mt-3 w-full text-center text-sm text-gray-600 hover:text-egg-yellow transition"
                    >
                        Ver detalles <i class="fas fa-arrow-right ml-1"></i>
                    </button>
                </div>
            `).join('');

            // Update favorite buttons after rendering
            setTimeout(() => {
                updateFavoriteButtons();
            }, 100);

            console.log('[Menu] Rendering complete');
        }

        // Filter Category
        function filterCategory(category) {
            currentCategory = category;

            // Update active pill
            document.querySelectorAll('.category-pill').forEach(pill => {
                pill.classList.remove('active');
            });
            event.target.closest('.category-pill').classList.add('active');

            renderMenu();
        }

        // Add to Cart
        function addToCart(slug) {
            const item = menuData.find(i => i.slug === slug);
            if (!item) return;

            const existingItem = cart.find(i => i.slug === slug);

            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({
                    ...item,
                    quantity: 1
                });
            }

            saveCartToStorage();
            updateCartUI();
            showToast(`${item.name} agregado al carrito`);

            // Track cart interaction for smart iOS prompt timing
            trackCartInteraction();

            // Send notification
            sendLocalNotification('Producto agregado', {
                body: `${item.name} agregado al carrito`,
                tag: 'cart-update',
                icon: item.image || '/images/6f694ae6-8898-4889-a769-82766dbf3725.png'
            });
        }

        // Remove from Cart
        function removeFromCart(slug) {
            cart = cart.filter(item => item.slug !== slug);
            saveCartToStorage();
            updateCartUI();
            renderCart();
        }

        // Update Quantity
        function updateQuantity(slug, change) {
            const item = cart.find(i => i.slug === slug);
            if (!item) return;

            item.quantity += change;

            if (item.quantity <= 0) {
                removeFromCart(slug);
                return;
            }

            saveCartToStorage();
            updateCartUI();
            renderCart();
        }

        // Update Cart UI
        function updateCartUI() {
            const cartCount = cart.reduce((sum, item) => sum + item.quantity, 0);
            const cartCountElement = document.getElementById('cart-count');

            if (cartCount > 0) {
                cartCountElement.textContent = cartCount;
                cartCountElement.classList.remove('hidden');
            } else {
                cartCountElement.classList.add('hidden');
            }
        }

        // Show Cart
        function showCart() {
            renderCart();
            document.getElementById('cart-modal').classList.add('show');
        }

        // Hide Cart
        function hideCart() {
            document.getElementById('cart-modal').classList.remove('show');
        }

        // Render Cart
        function renderCart() {
            const cartItems = document.getElementById('cart-items');
            const cartEmpty = document.getElementById('cart-empty');
            const cartFooter = document.getElementById('cart-footer');

            if (cart.length === 0) {
                cartItems.classList.add('hidden');
                cartFooter.classList.add('hidden');
                cartEmpty.classList.remove('hidden');
                return;
            }

            cartItems.classList.remove('hidden');
            cartFooter.classList.remove('hidden');
            cartEmpty.classList.add('hidden');

            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            cartItems.innerHTML = cart.map(item => `
                <div class="flex items-center gap-4 mb-4 pb-4 border-b border-gray-200">
                    <div class="w-20 h-20 bg-gradient-to-br from-egg-yellow to-sunny-orange rounded-xl flex items-center justify-center flex-shrink-0 overflow-hidden">
                        ${item.image ? `
                            <img src="${item.image}" alt="${item.name}" class="w-full h-full object-cover">
                        ` : `
                            <i class="fas ${item.category === 'Bebidas' ? 'fa-glass-water' : 'fa-egg'} text-white text-2xl"></i>
                        `}
                    </div>

                    <div class="flex-grow">
                        <h4 class="font-bold text-gray-800">${item.name}</h4>
                        <p class="text-sm text-gray-600">${formatPrice(item.price)} c/u</p>
                    </div>

                    <div class="quantity-control">
                        <button class="quantity-btn" onclick="updateQuantity('${item.slug}', -1)">-</button>
                        <span class="font-bold text-gray-800 min-w-[2rem] text-center">${item.quantity}</span>
                        <button class="quantity-btn" onclick="updateQuantity('${item.slug}', 1)">+</button>
                    </div>

                    <div class="text-right">
                        <p class="font-bold text-gray-800 mb-2">${formatPrice(item.price * item.quantity)}</p>
                        <button
                            onclick="removeFromCart('${item.slug}')"
                            class="text-red-500 hover:text-red-700 text-sm"
                        >
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');

            document.getElementById('cart-total').textContent = formatPrice(total);

            // Add event listener to address field for delivery estimate
            const addressField = document.getElementById('delivery-address');
            if (addressField && !addressField.dataset.listenerAdded) {
                addressField.dataset.listenerAdded = 'true';
                addressField.addEventListener('input', function() {
                    const address = this.value.trim();
                    if (address.length > 5) {
                        // Show estimate below address field
                        let estimateDiv = document.getElementById('delivery-estimate');
                        if (!estimateDiv) {
                            estimateDiv = document.createElement('div');
                            estimateDiv.id = 'delivery-estimate';
                            this.parentNode.insertBefore(estimateDiv, this.nextSibling.nextSibling || this.nextSibling);
                        }
                        estimateDiv.innerHTML = showDeliveryEstimate(address);
                    }
                });
            }
        }

        // Show Item Details
        function showItemDetails(slug) {
            const item = menuData.find(i => i.slug === slug);
            if (!item) return;

            const modalContent = document.getElementById('order-modal-content');

            modalContent.innerHTML = `
                <div class="mb-6 bg-gradient-to-br from-egg-yellow to-sunny-orange rounded-2xl overflow-hidden h-64">
                    ${item.image ? `
                        <img src="${item.image}" alt="${item.name}" class="w-full h-full object-cover">
                    ` : `
                        <div class="w-full h-full flex items-center justify-center">
                            <i class="fas ${item.category === 'Bebidas' ? 'fa-glass-water' : 'fa-egg'} text-white text-8xl"></i>
                        </div>
                    `}
                </div>

                <h3 class="font-display text-3xl text-gray-800 mb-3">${item.name}</h3>
                <p class="text-lg text-gray-700 mb-6">${item.desc || ''}</p>

                ${item.ingredients ? `
                    <div class="bg-warm-beige rounded-xl p-4 mb-6">
                        <h4 class="font-bold text-gray-800 mb-3">
                            <i class="fas fa-list-check text-fresh-green mr-2"></i>
                            Lo que incluye:
                        </h4>
                        <div class="grid grid-cols-2 gap-2">
                            ${item.ingredients.map(ing => `
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-circle-check text-fresh-green text-sm"></i>
                                    <span class="text-sm text-gray-700">${ing}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}

                <div class="flex items-center justify-between mb-6">
                    <span class="text-3xl font-bold text-gray-800">${formatPrice(item.price)}</span>
                </div>

                <button onclick="addToCart('${item.slug}'); hideOrderModal();" class="btn-primary w-full text-lg">
                    <i class="fas fa-cart-plus mr-2"></i>
                    Agregar al Carrito
                </button>
            `;

            document.getElementById('order-modal').classList.add('show');
        }

        // Hide Order Modal
        function hideOrderModal() {
            document.getElementById('order-modal').classList.remove('show');
        }

        // Proceed to Checkout
        async function proceedToCheckout() {
            const address = document.getElementById('delivery-address').value.trim();
            const phone = document.getElementById('delivery-phone').value.trim();

            if (!address) {
                alert('Por favor, ingresa tu direcci√≥n de entrega');
                return;
            }

            if (!phone) {
                alert('Por favor, ingresa tu tel√©fono de contacto');
                return;
            }

            // Calculate total
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            // Create order in Firebase first
            try {
                showToast('Creando pedido...');

                const orderData = {
                    items: cart,
                    total: total,
                    deliveryAddress: address,
                    phone: phone,
                    status: 'pending',
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    paymentMethod: 'online',
                    userId: currentUser ? currentUser.uid : null,
                    userEmail: currentUser ? currentUser.email : null,
                    userName: currentUser ? currentUser.displayName : null
                };

                const orderRef = await firebaseDb.ref('orders').push(orderData);
                const orderId = orderRef.key;

                // Save order info to localStorage for return from Stripe
                localStorage.setItem('ahuevo-pending-order', JSON.stringify({
                    orderId: orderId,
                    address: address,
                    phone: phone,
                    items: cart,
                    total: total,
                    timestamp: Date.now()
                }));

                // Save last order for quick reorder
                saveLastOrder(cart.map(item => ({ ...item })));

                showToast('Redirigiendo a Stripe...');

                // If single product with quantity 1, redirect directly to its Stripe URL
                if (cart.length === 1 && cart[0].quantity === 1) {
                    const item = cart[0];
                    const menuItem = menuData.find(i => i.slug === item.slug);
                    if (menuItem && menuItem.stripeUrl) {
                        window.location.href = menuItem.stripeUrl;
                        return;
                    }
                }

                // For multiple items or quantities > 1, we need to open multiple tabs or use a different approach
                // Option 1: Open first item and alert user about others
                if (cart.length === 1 && cart[0].quantity > 1) {
                    const item = cart[0];
                    const menuItem = menuData.find(i => i.slug === item.slug);
                    if (menuItem && menuItem.stripeUrl) {
                        alert(`Por favor completa el pago en Stripe. Necesitar√°s agregar ${item.quantity} unidades de ${item.name} en el carrito de Stripe.`);
                        window.location.href = menuItem.stripeUrl;
                        return;
                    }
                }

                // For multiple different items, redirect to first and show instructions
                if (cart.length > 1) {
                    let message = 'Tienes m√∫ltiples productos en tu carrito:\n\n';
                    cart.forEach(item => {
                        message += `${item.quantity}x ${item.name}\n`;
                    });
                    message += '\nPor favor, completa los pagos de Stripe para cada producto. ¬øDeseas continuar?';

                    if (confirm(message)) {
                        // Open all Stripe links
                        cart.forEach((item, index) => {
                            const menuItem = menuData.find(i => i.slug === item.slug);
                            if (menuItem && menuItem.stripeUrl) {
                                if (index === 0) {
                                    // First item: direct redirect
                                    setTimeout(() => {
                                        window.location.href = menuItem.stripeUrl;
                                    }, 100);
                                } else {
                                    // Other items: open in new tab
                                    setTimeout(() => {
                                        window.open(menuItem.stripeUrl, '_blank');
                                    }, index * 500); // Stagger opening to avoid popup blocking
                                }
                            }
                        });
                    }
                    return;
                }

                // Fallback: if no Stripe URL found
                alert('Error: No se encontr√≥ el enlace de pago de Stripe. Por favor contacta al restaurante.');

            } catch (error) {
                console.error('Error creating order:', error);
                alert('Error al procesar el pedido: ' + error.message);
            }
        }

        // Complete Order
        function completeOrder(orderId) {
            // Clear cart
            cart = [];
            saveCartToStorage();
            updateCartUI();
            hideCart();

            // Show success message
            alert(`¬°Pedido exitoso! Tu n√∫mero de orden es: ${orderId}\n\nPronto recibir√°s una confirmaci√≥n y el tiempo estimado de entrega.`);

            // Update order status
            if (firebaseDb) {
                firebaseDb.ref(`orders/${orderId}`).update({
                    status: 'preparing',
                    paidAt: firebase.database.ServerValue.TIMESTAMP
                });
            }
        }

        // Order via WhatsApp
        function orderWhatsApp() {
            const address = document.getElementById('delivery-address').value.trim();
            const phone = document.getElementById('delivery-phone').value.trim();

            if (!address) {
                alert('Por favor, ingresa tu direcci√≥n de entrega');
                return;
            }

            if (!phone) {
                alert('Por favor, ingresa tu tel√©fono de contacto');
                return;
            }

            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            let message = '¬°Hola! ü•ö Quiero hacer un pedido:\n\n';

            cart.forEach(item => {
                message += `${item.quantity}x ${item.name} - $${(item.price * item.quantity).toFixed(2)}\n`;
            });

            message += `\n*Total: $${total.toFixed(2)} USD*\n\n`;
            message += `üìç Direcci√≥n: ${address}\n`;
            message += `üì± Tel√©fono: ${phone}`;

            const whatsappUrl = `https://wa.me/526311081965?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');

            // Save order to Firebase
            if (firebaseDb) {
                firebaseDb.ref('orders').push({
                    items: cart,
                    total: total,
                    deliveryAddress: address,
                    phone: phone,
                    status: 'pending',
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    paymentMethod: 'whatsapp'
                });
            }
        }

        // Show My Orders
        async function showMyOrders() {
            if (!currentUser) {
                document.getElementById('my-orders-content').innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-clipboard-list text-6xl text-gray-300 mb-4"></i>
                        <p class="text-gray-600 text-lg mb-4">Inicia sesi√≥n para ver tus pedidos</p>
                        <button onclick="hideMyOrders(); showLoginModal();" class="btn-primary mt-4">
                            Iniciar Sesi√≥n
                        </button>
                    </div>
                `;
                document.getElementById('my-orders-modal').classList.add('show');
                return;
            }

            // Show loading
            document.getElementById('my-orders-content').innerHTML = `
                <div class="text-center py-12">
                    <div class="spinner mx-auto mb-4"></div>
                    <p class="text-gray-600">Cargando tus pedidos...</p>
                </div>
            `;
            document.getElementById('my-orders-modal').classList.add('show');

            try {
                // Fetch user's orders from Firebase
                const snapshot = await firebaseDb.ref('orders')
                    .orderByChild('userId')
                    .equalTo(currentUser.uid)
                    .once('value');

                const ordersData = snapshot.val();

                if (!ordersData) {
                    document.getElementById('my-orders-content').innerHTML = `
                        <div class="text-center py-12">
                            <i class="fas fa-receipt text-6xl text-gray-300 mb-4"></i>
                            <p class="text-gray-600 text-lg mb-4">No tienes pedidos a√∫n</p>
                            <button onclick="hideMyOrders()" class="btn-primary">
                                Explorar Men√∫
                            </button>
                        </div>
                    `;
                    return;
                }

                // Convert to array and sort by timestamp
                const ordersArray = Object.entries(ordersData).map(([id, order]) => ({
                    id,
                    ...order
                })).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                // Render orders
                document.getElementById('my-orders-content').innerHTML = ordersArray.map(order => `
                    <div class="border border-gray-200 rounded-xl p-4 mb-4">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <h3 class="font-bold text-gray-800">
                                    Pedido #${order.id.substring(0, 8)}
                                </h3>
                                <p class="text-sm text-gray-600">
                                    ${formatTime(order.timestamp)}
                                </p>
                            </div>
                            <div class="text-right">
                                <p class="text-2xl font-bold text-gray-800">$${order.total.toFixed(2)}</p>
                                <span class="status-indicator status-${order.status}">
                                    ${getStatusLabel(order.status)}
                                </span>
                            </div>
                        </div>

                        <div class="bg-gray-50 rounded-lg p-3 mb-3">
                            <p class="text-sm font-semibold text-gray-700 mb-2">Platillos:</p>
                            ${order.items.map(item => `
                                <div class="flex justify-between text-sm text-gray-600 mb-1">
                                    <span>${item.quantity}x ${item.name}</span>
                                    <span>$${(item.price * item.quantity).toFixed(2)}</span>
                                </div>
                            `).join('')}
                        </div>

                        <div class="text-sm text-gray-600">
                            <p><i class="fas fa-map-marker-alt mr-2"></i>${order.deliveryAddress}</p>
                            <p><i class="fas fa-phone mr-2"></i>${order.phone}</p>
                            ${order.paymentMethod === 'online' ?
                                '<p class="text-green-600"><i class="fas fa-check-circle mr-2"></i>Pagado en l√≠nea</p>' :
                                '<p class="text-blue-600"><i class="fab fa-whatsapp mr-2"></i>Pedido por WhatsApp</p>'
                            }
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading orders:', error);
                document.getElementById('my-orders-content').innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-exclamation-triangle text-6xl text-red-300 mb-4"></i>
                        <p class="text-gray-600 text-lg">Error al cargar los pedidos</p>
                        <button onclick="showMyOrders()" class="btn-primary mt-4">
                            Reintentar
                        </button>
                    </div>
                `;
            }
        }

        // Get Status Label
        function getStatusLabel(status) {
            const labels = {
                'pending': 'Pendiente',
                'preparing': 'En Preparaci√≥n',
                'delivering': 'En Entrega',
                'delivered': 'Entregado',
                'cancelled': 'Cancelado'
            };
            return labels[status] || status;
        }

        // Format Time
        function formatTime(timestamp) {
            if (!timestamp) return 'Hace un momento';

            const now = Date.now();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (days > 0) return `Hace ${days} d√≠a${days > 1 ? 's' : ''}`;
            if (hours > 0) return `Hace ${hours} hora${hours > 1 ? 's' : ''}`;
            if (minutes > 0) return `Hace ${minutes} minuto${minutes > 1 ? 's' : ''}`;
            return 'Hace un momento';
        }

        // Hide My Orders
        function hideMyOrders() {
            document.getElementById('my-orders-modal').classList.remove('show');
        }

        // Show Toast
        function showToast(message) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-message').textContent = message;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Storage Functions
        function saveCartToStorage() {
            localStorage.setItem('ahuevo-cart', JSON.stringify(cart));
        }

        function loadCartFromStorage() {
            const saved = localStorage.getItem('ahuevo-cart');
            if (saved) {
                try {
                    cart = JSON.parse(saved);
                } catch (e) {
                    cart = [];
                }
            }
        }

        // ===== AUTHENTICATION FUNCTIONS =====

        // Update Auth UI
        function updateAuthUI() {
            const loginBtn = document.getElementById('login-btn');
            const userMenuBtn = document.getElementById('user-menu-btn');
            const myOrdersBtn = document.getElementById('my-orders-btn');

            if (currentUser) {
                // User is logged in
                loginBtn.classList.add('hidden');
                userMenuBtn.classList.remove('hidden');
                myOrdersBtn.classList.remove('hidden');
            } else {
                // User is logged out
                loginBtn.classList.remove('hidden');
                userMenuBtn.classList.add('hidden');
                myOrdersBtn.classList.add('hidden');
            }
        }

        // Show Login Modal
        function showLoginModal() {
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('login-modal').classList.add('show');
        }

        // Hide Login Modal
        function hideLoginModal() {
            document.getElementById('login-modal').classList.remove('show');
        }

        // Show Register Form
        function showRegisterForm() {
            document.getElementById('register-form').classList.remove('hidden');
        }

        // Hide Register Form
        function hideRegisterForm() {
            document.getElementById('register-form').classList.add('hidden');
        }

        // Sign In with Google
        async function signInWithGoogle() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.setCustomParameters({
                    prompt: 'select_account'
                });

                const result = await firebaseAuth.signInWithPopup(provider);
                hideLoginModal();
                showToast(`¬°Bienvenido ${result.user.displayName}!`);
            } catch (error) {
                console.error('Error signing in with Google:', error);
                alert('Error al iniciar sesi√≥n con Google: ' + error.message);
            }
        }

        // Sign In with Email
        async function signInWithEmail(event) {
            event.preventDefault();

            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                const result = await firebaseAuth.signInWithEmailAndPassword(email, password);
                hideLoginModal();
                showToast(`¬°Bienvenido de nuevo!`);
            } catch (error) {
                console.error('Error signing in:', error);
                let errorMessage = 'Error al iniciar sesi√≥n';

                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'No existe una cuenta con este email';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Contrase√±a incorrecta';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Email inv√°lido';
                }

                alert(errorMessage);
            }
        }

        // Register with Email
        async function registerWithEmail(event) {
            event.preventDefault();

            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;

            try {
                const result = await firebaseAuth.createUserWithEmailAndPassword(email, password);

                // Update profile with name
                await result.user.updateProfile({
                    displayName: name
                });

                hideLoginModal();
                showToast(`¬°Cuenta creada exitosamente! Bienvenido ${name}`);
            } catch (error) {
                console.error('Error registering:', error);
                let errorMessage = 'Error al crear la cuenta';

                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Ya existe una cuenta con este email';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'La contrase√±a debe tener al menos 6 caracteres';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Email inv√°lido';
                }

                alert(errorMessage);
            }
        }

        // Toggle User Menu
        function toggleUserMenu() {
            if (confirm('¬øDeseas cerrar sesi√≥n?')) {
                signOut();
            }
        }

        // Sign Out
        async function signOut() {
            try {
                await firebaseAuth.signOut();
                showToast('Sesi√≥n cerrada correctamente');
            } catch (error) {
                console.error('Error signing out:', error);
                alert('Error al cerrar sesi√≥n');
            }
        }
    </script>
</body>
</html>
